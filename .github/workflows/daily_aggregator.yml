name: ciallo Daily Build

on:
  schedule:
    - cron: '0 0 */5 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # --- 第一阶段：下载与聚合 ---
  fetch_raw:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@main
      with:
        python-version: 'x' # 强制要求 3.11 以上版本以完美兼容 SSL start_tls 机制

    - name: Install Dependencies
      run: |
        pip install requests PyYAML

    - name: Run Aggregator Script
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python aggregator.py

    # 修改：不再将含有数千废弃节点的脏数据 push 到当前代码分支污染版本树
    # 仅将其作为跨 Job 工件流转，最大程度保持仓库体积轻盈
    - name: Upload Raw Artifact
      uses: actions/upload-artifact@main
      with:
        name: raw-nodes
        path: nodes.txt
        retention-days: 1

  # --- 第二阶段：测试、清洗与发布 ---
  check_active:
    needs: fetch_raw 
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@main

    - name: Set up Python
      uses: actions/setup-python@main
      with:
        python-version: 'x'

    - name: Download Raw Artifact
      uses: actions/download-artifact@main
      with:
        name: raw-nodes

    - name: Install Environment & Download GeoIP Database
      run: |
        pip install maxminddb
        # 下载免费开源的 MaxMind IP 地理库
        wget -qO geoip.mmdb "https://raw.githubusercontent.com/P3TERX/GeoLite.mmdb/download/geoip.mmdb"

    - name: Run Check Active Script
      run: |
        python check_active.py

    # 附加功能 D：工作流瘦身发布
    # 将最终产出的节点单独发布到 'release' 孤立分支，用户只需订阅 https://raw.github.../release/sub.txt
    - name: Publish to Release Branch
      run: |
        # 将成品放入独立发布池
        mkdir -p publish_dir
        cp sub.txt publish_dir/
        cp nodes.txt publish_dir/
        cd publish_dir
        
        git init
        git checkout -b release
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        git commit -m "Auto-update valid nodes [$(date)]" || exit 0
        
        # 强制推送到仓库的 release 分支，实现轻量化订阅发布
        git push --force "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" release
